<!DOCTYPE html>
<html>
<head>
    <!-- This template is an overlay for the webcam viewer cycler app. -->
    <title>
        Logan's RPI Webcam Cycler
    </title>
    <link rel="stylesheet" href="../static/styling.css">
</head>
<body>
    <main>
        <!-- video block here -->
        <div class="videoMainBlock">
                <iframe
                    class="VideoItem" 
                    id="iFrameElement"
                    src="id"
                    muted allowfullscreen webkitallowfullscreen mozallowfullscreen
                    allow="autoplay; fullscreen; encrypted-media"
                    frameborder="0"
                    >
                </iframe>

            <!-- this is where the upper title block is going -->
            <div class="MainTitle">
                <h1><span id = "Webcam_location_description"></span></h1>
                <h3><span id = "Webcam_local_time_"></span></h3>
            </div>
        </div>
    </main>
</body>

<script>
    function autoplay_NTV_streams(){
        // -------------- def fcn to auto click ---------------
        //get iframe element
        let iframeElement = document.getElementById("iFrameElement");

        //get center of iframe element
        const rect = iframeElement.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        var clickEvent = new MouseEvent("click", {
            view: window,
            bubbles: true,
            cancelable: true, 
            clientX: centerX,
            clientY: centerY, 
        });

        // click to play for NTV videos
        iframeElement.dispatchEvent(clickEvent);
        console.log("Autoclick fcn", centerX, centerY);
    }

    document.getElementById('iFrameElement').addEventListener("load",()=>{
        autoplay_NTV_streams()
    })

    document.addEventListener('DOMContentLoaded',function(){
        fetch("/contentLoaded/")
            .then(response => response.json())
            .then(data => {
            let t = data.Webcam_local_time;
            let webcamLocationDesc = data.webcamLocationDesc;
            let new_URL = data.ShuffledURL;
            
            //update time element
            let WebcamLocalTimeElement = document.getElementById("Webcam_local_time_");
            WebcamLocalTimeElement.innerText = {t};
            document.getElementById('Webcam_local_time_').innerText = t;

            // update location description element
            let webcamLocationDescElement = document.getElementById("Webcam_location_description");
            webcamLocationDescElement.innerText = {webcamLocationDesc};
            document.getElementById('Webcam_location_description').innerText = webcamLocationDesc;

            // update URL
            let iframeElement = document.getElementById("iFrameElement");
            iframeElement.src = new_URL;

            // call autoclick fcn
            autoplay_NTV_streams()

            console.log(data.webcamLocationDesc, data.ShuffledURL);
            });

    });
    
    function UpdateWebcamLocalTime(){
        fetch("/live/")
        .then(response => response.json())
        .then(data => {
            let t = data.Webcam_local_time;
            
            //update time element
            let WebcamLocalTimeElement = document.getElementById("Webcam_local_time_");
            WebcamLocalTimeElement.innerText = {t};
            document.getElementById('Webcam_local_time_').innerText = t;

            //console.log(data);
        })
    }

    function ShuffleVideoSource(){
        fetch("/shuffle/")
        .then(response => response.json())
        .then(data => {
            let t = data.Webcam_local_time;
            let webcamLocationDesc = data.webcamLocationDesc;
            let new_URL = data.ShuffledURL;

            //update time element
            let WebcamLocalTimeElement = document.getElementById("Webcam_local_time_");
            WebcamLocalTimeElement.innerText = {t};
            document.getElementById('Webcam_local_time_').innerText = t;

            // update location description element
            let webcamLocationDescElement = document.getElementById("Webcam_location_description");
            webcamLocationDescElement.innerText = {webcamLocationDesc};
            document.getElementById('Webcam_location_description').innerText = webcamLocationDesc;

            // update URL
            let iframeElement = document.getElementById("iFrameElement");
            iframeElement.src = new_URL;

            // call autoclick fcn
            // autoplay_NTV_streams()

            console.log(data.webcamLocationDesc, data.ShuffledURL);
        })
    }
    
    setInterval(UpdateWebcamLocalTime,1000)
    setInterval(ShuffleVideoSource,60000)
    
</script>
</html>